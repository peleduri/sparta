name: Sparta - Daily Organization Vulnerability Scan

on:
  push:
    branches:
      - main
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  scan-org-repos:
    name: Scan All Organization Repositories
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
      packages: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate GitHub App token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.SPARTA_APP_ID }}
          private-key: ${{ secrets.SPARTA_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Mask token and set environment
        id: mask-token
        env:
          GENERATED_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          if [ -z "$GENERATED_TOKEN" ]; then
            echo "GitHub App token generation failed" >&2
            exit 1
          fi
          echo "::add-mask::$GENERATED_TOKEN"
          echo "GITHUB_APP_TOKEN=$GENERATED_TOKEN" >> $GITHUB_ENV

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get all organization repositories
        id: get-repos
        env:
          GITHUB_ORG: ${{ github.repository_owner }}
          GITHUB_APP_TOKEN: ${{ env.GITHUB_APP_TOKEN }}
        run: |
          # Create a temp directory for file exchange
          # Mount it to /tmp in container so script can write to /tmp/repos.json
          TEMP_DIR=$(mktemp -d)
          chmod 777 "$TEMP_DIR"  # Ensure container user can write
          CONTAINER_ID=$(docker run -d \
            -v "${{ github.workspace }}":/workspace \
            -v "$TEMP_DIR":/tmp \
            -v "${{ github.output }}":/github_output \
            -w /workspace \
            -e GITHUB_ORG \
            -e GITHUB_APP_TOKEN \
            -e GITHUB_OUTPUT=/github_output \
            ghcr.io/${{ github.repository_owner }}/sparta:latest \
            get-repos)
          docker wait "$CONTAINER_ID"
          docker logs "$CONTAINER_ID"
          # Copy repos.json from container /tmp to workspace if it exists there
          if [ -f "$TEMP_DIR/repos.json" ]; then
            cp "$TEMP_DIR/repos.json" "${{ github.workspace }}/repos.json"
          fi
          docker rm "$CONTAINER_ID"
          rm -rf "$TEMP_DIR"
        continue-on-error: false

      - name: Scan each repository
        env:
          GITHUB_ORG: ${{ github.repository_owner }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_APP_TOKEN: ${{ env.GITHUB_APP_TOKEN }}
          GITHUB_WORKSPACE: ${{ github.workspace }}
        run: |
          docker run --rm \
            -v "${{ github.workspace }}":/workspace \
            -w /workspace \
            -e GITHUB_ORG \
            -e GITHUB_REPOSITORY \
            -e GITHUB_APP_TOKEN \
            -e GITHUB_WORKSPACE=/workspace \
            ghcr.io/${{ github.repository_owner }}/sparta:latest \
            scan-repos

      - name: Commit scan results
        env:
          GITHUB_APP_TOKEN: ${{ env.GITHUB_APP_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          docker run --rm \
            -v "${{ github.workspace }}":/workspace \
            -w /workspace \
            -e GITHUB_APP_TOKEN \
            -e GITHUB_REPOSITORY \
            ghcr.io/${{ github.repository_owner }}/sparta:latest \
            commit-results
