name: Query CVE

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      cve-id:
        description: 'CVE identifier to search for (e.g., CVE-2024-1234)'
        required: true
        type: string
      reports-dir:
        description: 'Directory containing vulnerability reports'
        required: false
        type: string
        default: 'vulnerability-reports'
      output-format:
        description: 'Output format (table or json)'
        required: false
        type: string
        default: 'table'
  workflow_call:
    inputs:
      cve-id:
        description: 'CVE identifier to search for (e.g., CVE-2024-1234)'
        required: true
        type: string
      reports-dir:
        description: 'Directory containing vulnerability reports'
        required: false
        type: string
        default: 'vulnerability-reports'
      output-format:
        description: 'Output format (table or json)'
        required: false
        type: string
        default: 'table'
    outputs:
      found:
        description: 'Whether CVE was found in any repository'
        value: ${{ jobs.query.outputs.found }}
      count:
        description: 'Number of occurrences found'
        value: ${{ jobs.query.outputs.count }}

jobs:
  query:
    name: Query CVE
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      found: ${{ steps.query.outputs.found }}
      count: ${{ steps.query.outputs.count }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Query CVE
        id: query
        env:
          CVE_ID: ${{ inputs.cve-id || github.event.inputs.cve-id || '' }}
          REPORTS_DIR: ${{ inputs.reports-dir || github.event.inputs.reports-dir || 'vulnerability-reports' }}
          OUTPUT_FORMAT: ${{ inputs.output-format || github.event.inputs.output-format || 'table' }}
        run: |
          python3 << 'EOF'
          import os
          import json
          import sys
          import re
          from pathlib import Path

          # CVE validation function
          def validate_cve_id(cve_id: str) -> bool:
              if not cve_id or not isinstance(cve_id, str):
                  return False
              pattern = r'^CVE-\d{4}-\d{4,}$'
              return bool(re.match(pattern, cve_id.upper()))
          
          # Path sanitization function
          def sanitize_path(user_path: str, base_dir: Path) -> Path:
              if not user_path or not isinstance(user_path, str):
                  raise ValueError("Path must be a non-empty string")
              base_dir = Path(base_dir).resolve()
              user_path = Path(user_path)
              if user_path.is_absolute():
                  resolved = user_path.resolve()
              else:
                  resolved = (base_dir / user_path).resolve()
              try:
                  resolved.relative_to(base_dir)
              except ValueError:
                  raise ValueError(f"Path traversal detected: {user_path} resolves outside base directory")
              return resolved

          cve_id = os.environ.get('CVE_ID', '').upper()
          if not cve_id:
              print("Error: CVE ID is required")
              sys.exit(1)
          
          # Validate CVE format
          if not validate_cve_id(cve_id):
              print(f"Error: Invalid CVE ID format: '{cve_id}'. Expected format: CVE-YYYY-NNNN+")
              sys.exit(1)
          
          # Sanitize and validate reports directory path
          try:
              base_dir = Path.cwd()
              reports_dir = sanitize_path(os.environ['REPORTS_DIR'], base_dir)
          except ValueError as e:
              print(f"Error: Invalid reports directory path: {e}")
              sys.exit(1)
          
          output_format = os.environ.get('OUTPUT_FORMAT', 'table')

          findings = []
          
          if not reports_dir.exists():
              print(f"Error: Reports directory '{reports_dir}' does not exist")
              sys.exit(1)
          
          # Walk through all report files
          for report_file in reports_dir.rglob('trivy-report.json'):
              try:
                  with open(report_file, 'r') as f:
                      report_data = json.load(f)
                  
                  # Extract repository info from path
                  parts = report_file.parts
                  if len(parts) >= 4:
                      org = parts[-4] if len(parts) >= 4 else 'unknown'
                      repo = parts[-3] if len(parts) >= 3 else 'unknown'
                      scan_date = parts[-2] if len(parts) >= 2 else 'unknown'
                  else:
                      org = 'unknown'
                      repo = 'unknown'
                      scan_date = 'unknown'
                  
                  # Check if report has error
                  if 'error' in report_data:
                      continue
                  
                  # Search for CVE in results
                  if 'Results' in report_data:
                      for result in report_data.get('Results', []):
                          if 'Vulnerabilities' in result:
                              for vuln in result['Vulnerabilities']:
                                  if vuln.get('VulnerabilityID') == cve_id:
                                      finding = {
                                          'cve': cve_id,
                                          'repository': f"{org}/{repo}",
                                          'org': org,
                                          'repo': repo,
                                          'scan_date': scan_date,
                                          'severity': vuln.get('Severity', 'UNKNOWN'),
                                          'package': vuln.get('PkgName', 'unknown'),
                                          'package_version': vuln.get('InstalledVersion', 'unknown'),
                                          'title': vuln.get('Title', ''),
                                          'description': vuln.get('Description', ''),
                                          'fixed_version': vuln.get('FixedVersion', ''),
                                          'published_date': vuln.get('PublishedDate', ''),
                                          'last_modified_date': vuln.get('LastModifiedDate', ''),
                                      }
                                      findings.append(finding)
              
              except json.JSONDecodeError as e:
                  print(f"Warning: Failed to parse {report_file}: {e}", file=sys.stderr)
                  continue
              except Exception as e:
                  print(f"Warning: Error processing {report_file}: {e}", file=sys.stderr)
                  continue
          
          # Set outputs
          found = 'true' if findings else 'false'
          count = len(findings)
          
          github_output = os.environ.get('GITHUB_OUTPUT', '/dev/stdout')
          with open(github_output, 'a') as f:
              f.write(f"found={found}\n")
              f.write(f"count={count}\n")
          
          # Generate output
          if output_format == 'json':
              output = json.dumps(findings, indent=2)
          else:
              # Table format
              if not findings:
                  output = f"No findings for {cve_id} in scanned repositories."
              else:
                  lines = []
                  lines.append(f"\n## Found {len(findings)} occurrence(s) of {cve_id}\n")
                  lines.append("| Repository | Severity | Package | Version | Scan Date |")
                  lines.append("|------------|----------|---------|---------|-----------|")
                  
                  for finding in findings:
                      repo = finding['repository']
                      severity = finding['severity']
                      pkg = finding['package']
                      version = finding['package_version']
                      scan_date = finding['scan_date']
                      lines.append(f"| {repo} | {severity} | {pkg} | {version} | {scan_date} |")
                  
                  lines.append("\n### Detailed Information\n")
                  
                  for i, finding in enumerate(findings, 1):
                      lines.append(f"\n#### {i}. {finding['repository']}")
                      lines.append(f"- **CVE**: {finding['cve']}")
                      lines.append(f"- **Severity**: {finding['severity']}")
                      lines.append(f"- **Package**: {finding['package']} (version: {finding['package_version']})")
                      if finding.get('fixed_version'):
                          lines.append(f"- **Fixed Version**: {finding['fixed_version']}")
                      if finding.get('title'):
                          lines.append(f"- **Title**: {finding['title']}")
                      if finding.get('published_date'):
                          lines.append(f"- **Published**: {finding['published_date']}")
                      lines.append(f"- **Scan Date**: {finding['scan_date']}")
                  
                  output = "\n".join(lines)
          
          # Print to console
          print(output)
          
          # Save to file for artifact
          with open('cve-query-results.txt', 'w') as f:
              f.write(output)
          
          if output_format == 'json':
              with open('cve-query-results.json', 'w') as f:
                  json.dump(findings, f, indent=2)
          
          # Exit with appropriate code
          sys.exit(0 if findings else 1)
          EOF

      - name: Upload query results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cve-query-results-${{ inputs.cve-id }}
          path: |
            cve-query-results.txt
            cve-query-results.json
          retention-days: 30

      - name: Set workflow summary
        if: always()
        run: |
          echo "## CVE Query Results: ${{ inputs.cve-id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.query.outputs.found }}" == "true" ]; then
            echo "✅ **Found**: ${{ steps.query.outputs.count }} occurrence(s)" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Not Found**: CVE not found in any scanned repository" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f cve-query-results.txt ]; then
            cat cve-query-results.txt >> $GITHUB_STEP_SUMMARY
          fi

