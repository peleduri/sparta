name: Daily Organization Vulnerability Scan

on:
  push:
    branches:
      - main
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  scan-org-repos:
    name: Scan All Organization Repositories
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests pygithub

      - name: Get all organization repositories
        id: get-repos
        env:
          APP_ID: ${{ secrets.SPARTA_APP_ID }}
          APP_PRIVATE_KEY: ${{ secrets.SPARTA_APP_PRIVATE_KEY }}
          GITHUB_ORG: ${{ github.repository_owner }}
        run: |
          python3 << 'EOF'
          import os
          import json
          from github import Github
          from github.Auth import AppAuth, Token

          app_id = int(os.environ['APP_ID'])
          private_key = os.environ['APP_PRIVATE_KEY']
          org_name = os.environ['GITHUB_ORG']
          
          # Handle private key - it might be base64 encoded or have escaped newlines
          # If it contains \n, replace them with actual newlines
          if '\\n' in private_key:
              private_key = private_key.replace('\\n', '\n')
          
          # Authenticate as GitHub App
          app_auth = AppAuth(app_id=app_id, private_key=private_key)
          app = Github(auth=app_auth)
          
          # Get installation for the organization
          try:
              installation = app.get_installation(org_name)
          except Exception as e:
              print(f"Error getting installation for {org_name}: {e}")
              print("Make sure the GitHub App is installed in the organization")
              raise
          
          # Create installation token
          installation_token = installation.create_access_token()
          
          # Use installation token to access organization (using new Auth API)
          token_auth = Token(installation_token.token)
          g = Github(auth=token_auth)
          org = g.get_organization(org_name)
          
          # Save installation token for later use
          with open('installation_token.txt', 'w') as f:
              f.write(installation_token.token)
          
          repos = []
          for repo in org.get_repos():
              repos.append({
                  'name': repo.name,
                  'full_name': repo.full_name,
                  'private': repo.private,
                  'default_branch': repo.default_branch
              })
          
          print(f"Found {len(repos)} repositories")
          
          # Save repos list to file
          with open('repos.json', 'w') as f:
              json.dump(repos, f, indent=2)
          
          # Set output (using new format)
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"count={len(repos)}\n")
          EOF

      - name: Setup Trivy
        uses: aquasecurity/setup-trivy@v0.2.0
        with:
          version: 'v0.65.0'
          cache: true

      - name: Scan each repository
        env:
          GITHUB_ORG: ${{ github.repository_owner }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          SCAN_DATE: ${{ github.run_id }}
        run: |
          python3 << 'EOF'
          import os
          import json
          import subprocess
          import shutil
          from pathlib import Path
          from datetime import datetime

          org_name = os.environ['GITHUB_ORG']
          current_repo = os.environ.get('GITHUB_REPOSITORY', '')
          scan_date = datetime.now().strftime('%Y%m%d')
          
          # Read installation token
          with open('installation_token.txt', 'r') as f:
              installation_token = f.read().strip()
          
          # Read repos list
          with open('repos.json', 'r') as f:
              repos = json.load(f)
          
          reports_dir = Path('vulnerability-reports') / org_name
          reports_dir.mkdir(parents=True, exist_ok=True)
          
          for repo in repos:
              repo_name = repo['name']
              repo_full_name = repo['full_name']
              default_branch = repo['default_branch']
              
              # Skip cloning Sparta repo since we're already in it
              if repo_full_name == current_repo:
                  print(f"\n{'='*60}")
                  print(f"Skipping clone for {repo_full_name} (already in this repository)")
                  print(f"Scanning current repository...")
                  print(f"{'='*60}")
                  
                  # Use current directory for scan
                  repo_dir = Path('.')
                  report_dir = reports_dir / repo_name / scan_date
                  report_dir.mkdir(parents=True, exist_ok=True)
                  
                  # Run Trivy scan on current directory
                  result = subprocess.run(
                      [
                          'trivy', 'fs',
                          '--format', 'json',
                          '--output', str(report_dir / 'trivy-report.json'),
                          '--timeout', '120m0s',
                          '--ignore-unfixed',
                          '--scanners', 'vuln',
                          '--vuln-type', 'os,library',
                          '--severity', 'CRITICAL,HIGH,MEDIUM,LOW',
                          '--cache-dir', f'{os.environ.get("GITHUB_WORKSPACE", ".")}/.cache/trivy',
                          '.'
                      ],
                      capture_output=True,
                      text=True,
                      timeout=900
                  )
                  
                  if result.returncode == 0:
                      print(f"✓ Scan completed for {repo_full_name}")
                  else:
                      print(f"⚠ Scan completed with warnings for {repo_full_name}")
                      if result.stderr:
                          print(result.stderr)
                  continue
              
              print(f"\n{'='*60}")
              print(f"Scanning: {repo_full_name}")
              print(f"{'='*60}")
              
              repo_dir = Path(f'tmp-{repo_name}')
              report_dir = reports_dir / repo_name / scan_date
              report_dir.mkdir(parents=True, exist_ok=True)
              
              try:
                  # Clone repository using installation token
                  clone_url = f"https://x-access-token:{installation_token}@github.com/{repo_full_name}.git"
                  
                  # Clone repository (token in URL is safe because we use capture_output=True)
                  clone_result = subprocess.run(
                      ['git', 'clone', '--depth', '1', '--branch', default_branch, clone_url, str(repo_dir)],
                      check=False,
                      capture_output=True,
                      text=True,
                      timeout=300
                  )
                  
                  if clone_result.returncode != 0:
                      error_msg = clone_result.stderr[:200] if clone_result.stderr else 'Unknown error'
                      # Sanitize error message to remove any potential token exposure
                      error_msg = error_msg.replace(installation_token, "***") if installation_token in error_msg else error_msg
                      raise Exception(f"Git clone failed: {error_msg}")
                  
                  # Run Trivy scan
                  result = subprocess.run(
                      [
                          'trivy', 'fs',
                          '--format', 'json',
                          '--output', str(report_dir / 'trivy-report.json'),
                          '--timeout', '120m0s',
                          '--ignore-unfixed',
                          '--scanners', 'vuln',
                          '--vuln-type', 'os,library',
                          '--severity', 'CRITICAL,HIGH,MEDIUM,LOW',
                          '--cache-dir', f'{os.environ.get("GITHUB_WORKSPACE", ".")}/.cache/trivy',
                          str(repo_dir)
                      ],
                      capture_output=True,
                      text=True,
                      timeout=900
                  )
                  
                  if result.returncode == 0:
                      print(f"✓ Scan completed for {repo_full_name}")
                  else:
                      print(f"⚠ Scan completed with warnings for {repo_full_name}")
                      print(result.stderr)
                  
              except subprocess.TimeoutExpired:
                  print(f"✗ Timeout scanning {repo_full_name}")
                  # Create empty report with error
                  error_report = {
                      'error': 'Scan timeout',
                      'repository': repo_full_name,
                      'timestamp': datetime.now().isoformat()
                  }
                  with open(report_dir / 'trivy-report.json', 'w') as f:
                      json.dump(error_report, f, indent=2)
              
              except Exception as e:
                  print(f"✗ Error scanning {repo_full_name}: {str(e)}")
                  # Create empty report with error
                  error_report = {
                      'error': str(e),
                      'repository': repo_full_name,
                      'timestamp': datetime.now().isoformat()
                  }
                  with open(report_dir / 'trivy-report.json', 'w') as f:
                      json.dump(error_report, f, indent=2)
              
              finally:
                  # Cleanup
                  if repo_dir.exists():
                      shutil.rmtree(repo_dir, ignore_errors=True)
          
          print(f"\n{'='*60}")
          print(f"Scanning complete. Reports saved to vulnerability-reports/{org_name}/")
          print(f"{'='*60}")
          EOF

      - name: Commit scan results
        env:
          INSTALLATION_TOKEN: ${{ steps.get-repos.outputs.installation_token }}
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add vulnerability-reports/
          if ! git diff --staged --quiet; then
            git commit -m "Daily vulnerability scan results - $(date +'%Y-%m-%d')"
            # Use installation token for push
            INSTALLATION_TOKEN=$(cat installation_token.txt)
            git remote set-url origin https://x-access-token:${INSTALLATION_TOKEN}@github.com/${{ github.repository }}.git
            git push origin main || echo "Push failed"
          else
            echo "No changes to commit"
          fi

