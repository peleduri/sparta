name: Package Vulnerability Scan

on:
  workflow_call:
    inputs:
      scan-ref:
        description: 'Path to scan (default: current directory)'
        required: false
        type: string
        default: '.'
      severity:
        description: 'Severity levels to check (default: CRITICAL,HIGH)'
        required: false
        type: string
        default: 'CRITICAL,HIGH'
      exit-code:
        description: 'Exit code when vulnerabilities found (default: 1)'
        required: false
        type: string
        default: '1'

jobs:
  trivy-scan:
    name: Trivy Vulnerability Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scan-ref: ${{ inputs.scan-ref }}
          output: 'trivy-report.json'
          format: 'json'
          timeout: '120m0s'
          ignore-unfixed: true
          exit-code: ${{ inputs.exit-code }}
          scanners: 'vuln'
          vuln-type: 'os,library'
          severity: ${{ inputs.severity }}
          cache-dir: ${{ github.workspace }}/.cache/trivy
          list-all-pkgs: false
          version: 'v0.65.0'
          cache: true
          skip-setup-trivy: false

